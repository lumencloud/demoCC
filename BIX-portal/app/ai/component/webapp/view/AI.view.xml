<mvc:View controllerName="bix.ai.component.controller.AI"
    displayBlock="true" height="100%"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:f="sap.f"
    xmlns:core="sap.ui.core"
    xmlns:tnt="sap.tnt"
    xmlns:form="sap.ui.layout.form"
    xmlns:layout="sap.ui.layout"    
    xmlns="sap.m">
    <f:DynamicPage showFooter="true" class="sapUiContentPadding custom-ai-page"> 
        <f:content>
            <Panel height="100%" class="chat-panel-container">
                <content>
                    <VBox visible="{chat>/showWelcome}">
                        <HBox justifyContent="Center" class="sapUiSmallMarginTop">
                            <tnt:InfoLabel text="2025.06.01(일)" class="custom-ai-date-label"/>
                        </HBox>
                        <Image src="./resource/image/botImg.png" class="custom-ai-image"></Image>
                        <Title text="안녕하세요. 인공지능 챗봇입니다. 무엇을 도와드릴까요?" 
                               wrapping="true" titleStyle="H2"></Title>
                        <FlexBox class="custom-ai-button-container">
                            <Button text="실적 PL" press="onQuickActionPress"/>
                            <Button text="추정 PL" press="onQuickActionPress"/>
                            <Button text="매출/마진 상세" press="onQuickActionPress"/>
                            <Button text="SG&amp;A 상세" press="onQuickActionPress"/>
                            <Button text="DT과제 상세" press="onQuickActionPress"/>
                            <Button text="Offshoring 상세" press="onQuickActionPress"/>
                            <Button text="BR 실적 상세" press="onQuickActionPress"/>                         
                        </FlexBox>
                        <VBox height="30rem"></VBox>             
                    </VBox>
                    
                    <!-- 개선된 채팅 메시지 영역 (세로 크기 최대화) -->
                    <VBox visible="{= !${chat>/showWelcome}}" class="chat-main-container">
                        <!-- 채팅 헤더 -->
                        <HBox class="chat-header">
                            <HBox alignItems="Center" class="chat-header-content">
                                <core:Icon src="sap-icon://robot" size="1.5rem" color="white" class="chat-header-icon"/>
                                <Title text="AI 어시스턴트" class="chat-header-title"/>
                            </HBox>
                            <Button 
                                icon="sap-icon://decline"
                                press="onToggleChat"
                                class="chat-close-button"
                                tooltip="대화창 닫기"/>
                        </HBox>
                        
                        <!-- 채팅 메시지 스크롤 영역 (높이 최대화) -->
                        <ScrollContainer 
                            id="chatContainer"
                            height="calc(100vh - 280px)"
                            vertical="true" 
                            class="chat-messages-container">
                            <VBox class="chat-messages-wrapper">
                                <!-- 메시지 리스트 -->
                                <List items="{chat>/messages}" showSeparators="None" class="chat-message-list">
                                    <CustomListItem class="chat-message-item">
                                        <VBox width="100%">
                                            <!-- 사용자 메시지 -->
                                            <HBox visible="{= ${chat>type} === 'user'}" 
                                                  justifyContent="End" 
                                                  class="user-message-row">
                                                <VBox class="user-message-bubble">
                                                    <Text text="{chat>content}" class="user-message-text"/>
                                                    <Text text="{chat>displayTime}" class="message-time user-time"/>
                                                </VBox>
                                            </HBox>
                                            
                                            <!-- AI 메시지 -->
                                            <HBox visible="{= ${chat>type} === 'ai'}" 
                                                class="ai-message-row">
                                                <HBox class="ai-message-wrapper">
                                                    <!-- AI 아바타 (에이전트별 아이콘과 색상) -->
                                                    <VBox class="ai-avatar-container">
                                                        <core:Icon src="{path: 'chat>selectedAgent', formatter: '.formatAgentIcon'}" 
                                                                size="2rem" 
                                                                color="white" 
                                                                class="ai-avatar-icon"/>
                                                    </VBox>
                                                    
                                                    <!-- AI 메시지 내용 -->
                                                    <VBox class="ai-message-content">
                                                        <!-- 선택된 에이전트 표시 (이름 매핑 적용) -->
                                                        <HBox visible="{chat>hasAgent}" class="ai-agent-badge-container">
                                                            <HBox class="{path: 'chat>selectedAgent', formatter: '.formatAgentBadgeClass'}" alignItems="Center">
                                                                <core:Icon src="{path: 'chat>selectedAgent', formatter: '.formatAgentIcon'}" 
                                                                        size="1rem" 
                                                                        color="{path: 'chat>selectedAgent', formatter: '.formatAgentColor'}"
                                                                        class="ai-agent-badge-icon"/>
                                                                <Text text="{path: 'chat>selectedAgent', formatter: '.formatAgentName'}" 
                                                                    class="ai-agent-badge-text"/>
                                                            </HBox>
                                                        </HBox>
                                                        
                                                        <!-- 메시지 버블 -->
                                                        <VBox class="ai-message-bubble">
                                                            <!-- 메인 텍스트 응답 -->
                                                            <FormattedText htmlText="{chat>content}" class="ai-message-text"/>
                                                            
                                                            <!-- *** 여기에 네비게이션 링크 섹션 추가 *** -->
                                                            <VBox visible="{chat>hasNavigation}" class="ai-navigation-section">
                                                                <!-- 0개 메뉴: 메인 화면으로 안내 -->
                                                                <VBox visible="{= ${chat>navigationData/type} === 'no_menu'}" 
                                                                    class="navigation-no-menu">
                                                                    <Text text="요청하신 화면을 찾을 수 없습니다." 
                                                                        class="navigation-text navigation-message"/>
                                                                    <Button text="메인 화면으로 이동" 
                                                                            press="onMainNavigationPress" 
                                                                            type="Emphasized"
                                                                            class="navigation-button-main"/>
                                                                </VBox>

                                                                <!-- 2개 이상 메뉴: 선택 가능한 링크들 -->
                                                                <VBox visible="{= ${chat>navigationData/type} === 'multiple_menus'}" 
                                                                    class="navigation-multiple-menus">
                                                                    <Text text="다음 화면 중 선택해주세요:" 
                                                                        class="navigation-title navigation-message"/>
                                                                    <VBox class="navigation-buttons-container">
                                                                        <List items="{chat>navigationData/menus}" 
                                                                            mode="None" 
                                                                            showSeparators="None"
                                                                            class="navigation-menu-list">
                                                                            <CustomListItem class="navigation-menu-item">
                                                                                <Button text="{chat>name}" 
                                                                                        press="onMenuNavigationPress" 
                                                                                        type="Transparent"
                                                                                        width="100%"
                                                                                        class="navigation-button-menu"/>
                                                                            </CustomListItem>
                                                                        </List>
                                                                    </VBox>
                                                                </VBox>
                                                            </VBox>
                                                            
                                                            <!-- 기존 테이블 데이터 -->
                                                            <Table visible="{chat>hasTableData}" 
                                                                items="{chat>tableData}" 
                                                                class="ai-data-table">
                                                                <columns>
                                                                    <Column width="35%"><Text text="부서명" class="table-header"/></Column>
                                                                    <Column width="25%"><Text text="유형" class="table-header"/></Column>
                                                                    <Column width="40%"><Text text="금액" class="table-header"/></Column>
                                                                </columns>
                                                                <items>
                                                                    <ColumnListItem class="table-row">
                                                                        <Text text="{chat>div_name}" class="table-cell"/>
                                                                        <Text text="{chat>type}" class="table-cell"/>
                                                                        <Text text="{path: 'chat>total_data', formatter: '.formatNumber'}" class="table-cell table-number"/>
                                                                    </ColumnListItem>
                                                                </items>
                                                            </Table>
                                                            
                                                            <Text text="{chat>displayTime}" class="message-time ai-time"/>
                                                        </VBox>
                                                    </VBox>
                                                </HBox>
                                            </HBox>
                                        </VBox>
                                    </CustomListItem>
                                </List>
                                
                                <!-- 로딩 표시 -->
                                <HBox visible="{chat>/isLoading}" class="ai-message-row">
                                    <HBox class="ai-message-wrapper">
                                        <!-- AI 아바타 (로딩 중일 때는 기본 로봇 아이콘) -->
                                        <VBox class="ai-avatar-container">
                                            <core:Icon src="sap-icon://robot" 
                                                     size="2rem" 
                                                     color="white" 
                                                     class="ai-avatar-icon loading-avatar"/>
                                        </VBox>
                                        
                                        <!-- 로딩 메시지 -->
                                        <VBox class="ai-message-content">
                                            <VBox class="ai-message-bubble loading-bubble">
                                                <HBox alignItems="Center" class="loading-content">
                                                    <BusyIndicator size="1.2rem" class="loading-spinner"/>
                                                    <Text text="응답을 생성하고 있습니다..." class="loading-text"/>
                                                </HBox>
                                            </VBox>
                                        </VBox>
                                    </HBox>
                                </HBox>
                            </VBox>
                        </ScrollContainer>
                    </VBox>
                </content>            
            </Panel>
        </f:content>
        <f:footer>
            <Toolbar class="custom-ai-toolbar">
                <ToolbarSpacer />
                <SearchField 
                    id="SearchFieldId"
                    placeholder="궁금한 사항을 입력해 주세요"
                    class="custom-ai-searchField"
                    showSearchButton="true"
                    search="onSearch">
                </SearchField>
                <ToolbarSpacer /> 
            </Toolbar>
        </f:footer>
    </f:DynamicPage>    
</mvc:View>